<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026æ±äº¬ç¨æ—…è‡ªç”±è¡Œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #F7F4EB;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.8);
            --soft-shadow: 4px 4px 16px #E0E5D5, -4px -4px 16px #FFFFFF;
            --text-main: #4A4A4A;
            --text-sub: #8E8E93;
            --tag-transport: #8AB4F8;
            --tag-attraction: #81C995;
            --tag-food: #FFB067;
            --tag-alert: #FF8A65;
            --accent-color: #A3C7B6;
            --tip-bg: rgba(255, 176, 103, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Varela Round', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100" height="100" filter="url(%23noise)" opacity="0.05"/></svg>');
            color: var(--text-main); display: flex; justify-content: center;
        }

        #app { width: 100%; max-width: 430px; height: 100dvh; position: relative; display: flex; flex-direction: column; overflow: hidden;}

        /* å…±ç”¨ç»ç’ƒè³ªæ„Ÿ */
        .glass { background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: var(--soft-shadow); }

        /* --- Header --- */
        header { padding: 15px 20px 5px; z-index: 10; transition: 0.3s; }
        .header-title { font-size: 22px; font-weight: 700; letter-spacing: 1px; margin-bottom: 8px; }
        
        .weather-card {
            display: block; padding: 8px 15px; font-size: 13px; font-weight: 700; text-decoration: none; color: var(--text-main); 
            transition: transform 0.2s; margin-bottom: 5px; border-radius: 16px; position: relative; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.4); box-shadow: 2px 2px 10px rgba(0,0,0,0.03);
        }
        .weather-card::before {
            content: ''; position: absolute; inset: 0; z-index: -1;
            background: rgba(247, 244, 235, 0.3); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            filter: url(#liquid-filter); pointer-events: none;
        }
        .weather-card:active { transform: scale(0.98); }
        .weather-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .weather-desc { font-size: 11px; color: var(--text-sub); font-weight: 500;}

        /* å…§å®¹å€ */
        .content-area { flex: 1; overflow-y: auto; padding: 0 20px 100px; scrollbar-width: none; }
        .content-area::-webkit-scrollbar { display: none; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- iOS 26 Liquid Glass å‡çµåˆ—è¨­è¨ˆ --- */
        .sticky-header { position: sticky; top: 0; z-index: 50; margin: 0 -20px 10px -20px; padding: 10px 20px; }
        .liquid-bg::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(247, 244, 235, 0.4); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            filter: url(#liquid-filter); mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%); z-index: -1; pointer-events: none;
        }

        /* --- 1. è¡Œç¨‹ Tab --- */
        .date-picker { display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; padding-bottom: 5px; }
        .date-picker::-webkit-scrollbar { display: none; }
        .date-chip { min-width: 75px; padding: 10px 5px; text-align: center; cursor: pointer; border-radius: 20px; font-size: 13px; font-weight: 700; color: var(--text-sub); transition: 0.3s; box-shadow: 2px 2px 8px rgba(0,0,0,0.05); background: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.9);}
        .date-chip.active { background: var(--accent-color); color: white; transform: scale(1.05); border:none;}

        .timeline { position: relative; padding-left: 20px; margin-top: 5px; }
        .timeline::before { content: ''; position: absolute; left: 6px; top: 0; bottom: 0; width: 2px; background: rgba(0,0,0,0.05); }
        .timeline-item { position: relative; margin-bottom: 24px; }
        .timeline-dot { position: absolute; left: -21px; top: 5px; width: 14px; height: 14px; border-radius: 50%; border: 3px solid var(--bg-color); z-index: 2; }
        .timeline-card { padding: 16px; }
        .time-text { font-size: 12px; color: var(--text-sub); margin-bottom: 4px; font-weight: 700;}
        .title-text { font-size: 16px; font-weight: 700; margin-bottom: 8px; line-height: 1.4;}
        .desc-text { font-size: 13px; color: var(--text-main); margin-bottom: 12px; line-height: 1.5;}
        
        .nav-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: rgba(255,255,255,0.9); border-radius: 16px; font-size: 12px; color: var(--text-main); text-decoration: none; font-weight: 700; box-shadow: 2px 2px 8px rgba(0,0,0,0.03); transition: 0.2s; margin-right: 5px; margin-top: 5px;}
        .nav-btn:active { transform: scale(0.95); }
        .nav-btn.external { background: #FFF3E0; color: #E65100; }
        .nav-btn.photo { background: #E3F2FD; color: #1565C0; }
        
        .tip-box { margin-top: 12px; padding: 10px 12px; background: var(--tip-bg); border-left: 3px solid #FFA000; border-radius: 8px; font-size: 12px; color: #555; display: flex; gap: 8px; align-items: flex-start; line-height: 1.5; }
        
        details.sub-spots { margin-top: 12px; background: rgba(255,255,255,0.6); border-radius: 12px; overflow: hidden; }
        details.sub-spots summary { padding: 10px 15px; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: space-between; list-style: none; }
        details.sub-spots summary::-webkit-details-marker { display: none; }
        details.sub-spots summary::after { content: '\f078'; font-family: 'FontAwesome'; font-size: 10px; transition: 0.3s; color: var(--text-sub); }
        details.sub-spots[open] summary::after { transform: rotate(180deg); color: var(--accent-color); }
        .sub-spot-item { padding: 12px 15px; border-top: 1px dashed rgba(0,0,0,0.08); font-size: 13px; }
        .sub-spot-title { font-weight: 700; color: var(--text-main); margin-bottom: 4px; display: flex; align-items: center; gap: 6px;}

        /* é«˜äº®æ–‡å­— (è·¨é è·³è½‰) */
        .highlight-ticket { color: #e91e63; font-weight: 700; background: rgba(233, 30, 99, 0.1); padding: 4px 8px; border-radius: 6px; cursor: pointer; display: inline-block; transition: 0.2s; box-shadow: 1px 1px 4px rgba(233, 30, 99, 0.2);}
        .highlight-ticket:active { transform: scale(0.95); opacity: 0.8; }
        .highlight-reserve { color: #d32f2f; font-weight: 700; background: rgba(211, 47, 47, 0.1); padding: 4px 8px; border-radius: 6px; display: inline-block; cursor: pointer; transition: 0.2s; box-shadow: 1px 1px 4px rgba(211, 47, 47, 0.2);}
        .highlight-reserve:active { transform: scale(0.95); opacity: 0.8; }

        .cat-transport .timeline-dot { background: var(--tag-transport); }
        .cat-attraction .timeline-dot { background: var(--tag-attraction); }
        .cat-food .timeline-dot { background: var(--tag-food); }
        .cat-alert .timeline-dot { background: var(--tag-alert); }

        /* --- 2. é è¨‚ Tab --- */
        details.glass-accordion { margin-bottom: 15px; border-radius: 24px; overflow: hidden; }
        summary.accordion-header { padding: 18px 20px; font-weight: 700; font-size: 16px; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.4); }
        summary.accordion-header::-webkit-details-marker { display: none; }
        summary.accordion-header::after { content: '\f078'; font-family: 'FontAwesome'; font-weight: 900; color: var(--text-sub); transition: 0.3s; }
        details.glass-accordion[open] summary.accordion-header::after { transform: rotate(180deg); color: var(--accent-color); }
        .accordion-content { padding: 20px; border-top: 1px solid rgba(255,255,255,0.5); }
        .bp-divider { border-top: 2px dashed rgba(0,0,0,0.1); margin: 15px 0; }
        .bp-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .bp-label { font-size: 11px; color: var(--text-sub); }
        .bp-val { font-size: 15px; font-weight: 700; }
        .ticket-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .ticket-item:last-child { border-bottom: none; }
        .ticket-icon { width: 40px; height: 40px; background: white; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 18px; box-shadow: 2px 2px 8px rgba(0,0,0,0.05); margin-right: 12px; flex-shrink: 0;}
        .link-btn { background: var(--accent-color); color: white; padding: 6px 12px; border-radius: 12px; font-size: 12px; text-decoration: none; font-weight: 700; white-space: nowrap;}
        .qr-img { width: 65px; height: 65px; border-radius: 8px; border: 2px solid white; box-shadow: 2px 2px 8px rgba(0,0,0,0.1); object-fit: cover;}

        /* --- 3. è¨˜å¸³ Tab --- */
        .expense-dash { text-align: center; padding: 15px; }
        .total-twd { font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px; }
        .total-jpy { font-size: 14px; color: var(--text-sub); }
        .expense-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; margin-top: 10px;}
        .input-glass { border: none; background: rgba(255,255,255,0.8); padding: 12px; border-radius: 16px; font-size: 15px; outline: none; box-shadow: inset 2px 2px 6px rgba(0,0,0,0.03); color: var(--text-main); font-weight: 500; appearance: none; width: 100%;}
        .btn-add { grid-column: span 2; background: var(--accent-color); color: white; border: none; padding: 14px; border-radius: 16px; font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.2s;}
        .daily-expense-group { margin-bottom: 20px; }
        .daily-expense-title { font-size: 14px; font-weight: 700; color: var(--text-sub); margin-bottom: 10px; padding-left: 5px; display: flex; justify-content: space-between;}
        
        /* ğŸ”¥ iOS åŸç”Ÿæ»‘å‹•åˆªé™¤ */
        .swipe-wrapper { overflow: hidden; border-radius: 16px; margin-bottom: 8px; position: relative; background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--glass-border); box-shadow: var(--soft-shadow); }
        .swipe-track { display: flex; flex-wrap: nowrap; width: 100%; transform: translateX(0); transition: transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .swipe-content { flex: 0 0 100%; width: 100%; display: flex; justify-content: space-between; padding: 16px; align-items: center; box-sizing: border-box; background: transparent; }
        .swipe-actions { flex: 0 0 140px; display: flex; }
        .swipe-btn { border: none; flex: 1; color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; outline: none; transition: 0.2s;}
        .swipe-btn:active { filter: brightness(0.8); }
        .swipe-btn.edit { background: #FFB067; }
        .swipe-btn.delete { background: #E53935; }

        /* --- 4. åœ°åœ– Tab --- */
        .map-route-card { padding: 20px; margin-bottom: 15px; }
        .map-stops { margin: 15px 0; padding-left: 10px; border-left: 2px dashed var(--accent-color); }
        .map-stop-item { position: relative; padding-left: 15px; margin-bottom: 12px; font-size: 14px; font-weight: 700; }
        .map-stop-item::before { content: ''; position: absolute; left: -21px; top: 4px; width: 10px; height: 10px; background: var(--accent-color); border-radius: 50%; border: 2px solid var(--bg-color); }
        .route-btn { display: block; width: 100%; text-align: center; background: #4285F4; color: white; padding: 14px; border-radius: 16px; font-weight: 700; text-decoration: none; box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3); margin-top: 15px; }

        /* --- 5. æº–å‚™ Tab --- */
        .check-group { margin-bottom: 24px; }
        .check-group h3 { font-size: 15px; margin-bottom: 12px; color: var(--text-sub); padding-left: 5px;}
        .check-item { display: flex; align-items: center; gap: 12px; padding: 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;}
        .check-box { width: 22px; height: 22px; border: 2px solid var(--accent-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .check-item.done .check-box { background: var(--accent-color); }
        .check-item.done .check-box::after { content: 'âœ“'; color: white; font-size: 14px; }
        .check-item.done .check-text { text-decoration: line-through; color: var(--text-sub); }

        /* --- iOS 26 Bottom Nav --- */
        nav { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            height: 75px; padding: 0 35px 10px 35px; 
            display: flex; justify-content: space-between; align-items: center; z-index: 100; 
        }
        nav::before { 
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); 
            filter: url(#liquid-filter); border-top: 1px solid rgba(255,255,255,0.6); z-index: -1; 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-sub); cursor: pointer; transition: 0.3s; width: 45px; }
        .nav-item i { font-size: 20px; transition: transform 0.3s; }
        .nav-item span { font-size: 10px; font-weight: 700; }
        .nav-item.active { color: var(--accent-color); }
        .nav-item.active i { transform: translateY(-4px) scale(1.2); }
    </style>
</head>
<body>

<!-- SVG Liquid Glass æ¿¾é¡ -->
<svg style="width:0;height:0;position:absolute;">
    <filter id="liquid-filter">
        <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="3" result="noise" />
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="G" />
    </filter>
</svg>

<div id="app">
    <!-- Header -->
    <header id="main-header">
        <div class="header-title">2026æ±äº¬ç¨æ—… ğŸ‡¯ğŸ‡µ</div>
        <a href="https://tenki.jp/forecast/3/16/4410/13101/" target="_blank" class="weather-card" id="weather-display">
            <div class="weather-top">
                <span>ğŸ“ æ±äº¬å³æ™‚å¤©æ°£ (é»æ“Šçœ‹è©³æƒ…)</span>
                <span><i class="fa-solid fa-spinner fa-spin"></i></span>
            </div>
            <div class="weather-desc">é€£ç·šä¸­ï¼Œè«‹ç¨å€™...</div>
        </a>
    </header>

    <div class="content-area">
        <!-- 1. è¡Œç¨‹ Tab -->
        <div id="tab-schedule" class="tab-content active">
            <div class="sticky-header liquid-bg">
                <div class="date-picker" id="date-picker-schedule"></div>
            </div>
            <div id="day-title" style="margin: 5px 5px 15px; font-weight: 700; font-size: 18px;"></div>
            <div class="timeline" id="timeline-container"></div>
        </div>

        <!-- 2. é è¨‚ Tab -->
        <div id="tab-bookings" class="tab-content">
            <details class="glass glass-accordion" open>
                <summary class="accordion-header"><i class="fa-solid fa-plane-departure"></i> èˆªç­è³‡è¨Š</summary>
                <div class="accordion-content">
                    <div class="bp-row"><div><div class="bp-label">å»ç¨‹ (è™èˆª)</div><div class="bp-val">3/12 06:15</div></div><div class="bp-val" style="color:var(--accent-color);">IT200</div></div>
                    <div class="bp-row" style="font-size:12px;"><span>TPE (æ¡ƒåœ’ T1)</span><i class="fa-solid fa-arrow-right"></i><span>NRT (æˆç”°)</span></div><div class="bp-label">åº§ä½: 25A</div>
                    <!-- æ¥é€æ©Ÿæç¤º -->
                    <div style="margin-top: 8px; text-align: left;">
                        <span style="font-size: 11px; color: #E53935; font-weight: 700;"><i class="fa-solid fa-car"></i> ã€å·²é ç´„æ©Ÿå ´æ¥é€ã€‘03:30 å‡ºç™¼</span>
                    </div>
                    <div class="bp-divider"></div>
                    <div class="bp-row"><div><div class="bp-label">å›ç¨‹ (æ˜Ÿå®‡)</div><div class="bp-val">3/17 15:40</div></div><div class="bp-val" style="color:var(--accent-color);">JX803</div></div>
                    <div class="bp-row" style="font-size:12px;"><span>NRT (æˆç”° T2)</span><i class="fa-solid fa-arrow-right"></i><span>TPE (æ¡ƒåœ’)</span></div><div class="bp-label">åº§ä½: 33K</div>
                </div>
            </details>
            <details class="glass glass-accordion" open>
                <summary class="accordion-header"><i class="fa-solid fa-ticket"></i> é–€ç¥¨ / æ†‘è­‰</summary>
                <div class="accordion-content">
                    <div class="ticket-item" style="align-items:flex-start;">
                        <div style="display:flex;gap:12px;">
                            <div class="ticket-icon" style="color:#2b82c9;"><i class="fa-solid fa-tower-broadcast"></i></div>
                            <div>
                                <div style="font-weight:700;font-size:14px;">æ±äº¬æ™´ç©ºå¡”</div>
                                <div class="bp-label">3/12 17:00 å…¥å ´<br>é»åœ–é–‹æ†‘è­‰ â¡ï¸</div>
                            </div>
                        </div>
                        <a href="https://drive.google.com/file/d/1tIjH1z_qraS3Jtdz0o4o_uH4H6PDmjb5/view?usp=drive_link" target="_blank">
                            <img src="https://lh3.googleusercontent.com/d/1anMF1YFB2KYnvr0h5Bw5StxwSyV6YxI0" alt="æ™´ç©ºå¡”QR" class="qr-img">
                        </a>
                    </div>
                    <div class="ticket-item">
                        <div style="display:flex;gap:12px;align-items:center;">
                            <div class="ticket-icon" style="color:#e91e63;">ğŸ¨</div>
                            <div><div style="font-weight:700;font-size:14px;">éº»å¸ƒå° teamLab</div><div class="bp-label">3/16 09:00 å…¥å ´</div></div>
                        </div>
                        <a href="https://borderless-azabudai.ticket.teamlab.art/tickets/#/id/tTPJJrgbLnrshz6m4c1xxp8RQuK6vfIXiGCYbJa6cROxMFPpPzKjHqFRY_YQpSwG?lang=zh-hant" target="_blank" class="link-btn">é–‹å•Ÿç¥¨åˆ¸</a>
                    </div>
                </div>
            </details>
            <details class="glass glass-accordion" open>
                <summary class="accordion-header"><i class="fa-solid fa-utensils"></i> é¤å»³é è¨‚</summary>
                <div class="accordion-content">
                    <div class="ticket-item">
                        <div style="display:flex;gap:12px;align-items:center;"><div class="ticket-icon">ğŸ¥©</div>
                        <div><div style="font-weight:700;font-size:14px;">Ushigoro éŠ€åº§</div><div class="bp-label">3/15 12:00</div></div></div>
                        <a href="https://r.tablecheck.co/CL0/https:%2F%2Fwww.tablecheck.com%2Fja%2Freservations%2F5GUDSY/1/0100019c54fe764b-b2b29c69-4fd4-42d6-8c66-d0c9ef57e3a1-000000/Psw45Hx90vuFmpJmLQgIymwZXrDmSapaFguY1HQMl9M=444" target="_blank" class="link-btn" style="background:#d32f2f;">æŸ¥çœ‹è¨‚ä½</a>
                    </div>
                    <div class="ticket-item">
                        <div style="display:flex;gap:12px;align-items:center;"><div class="ticket-icon">ğŸ²</div>
                        <div><div style="font-weight:700;font-size:14px;">ä»ŠåŠ ä¸Šé‡å»£å°è·¯</div><div class="bp-label">3/17 11:30</div></div></div>
                        <a href="https://r.tablecheck.co/CL0/https:%2F%2Fwww.tablecheck.com%2Fja%2Freservations%2FKQHM59/1/0100019c07cc8607-b058db8b-1757-47ff-8f17-284d79e685c1-000000/pLCZrneoqlqrgvJUqcvUeZ0YYIu2LIH_6uoqfXmzrbk=442" target="_blank" class="link-btn" style="background:#d32f2f;">æŸ¥çœ‹è¨‚ä½</a>
                    </div>
                </div>
            </details>
        </div>

        <!-- 3. è¨˜å¸³ Tab -->
        <div id="tab-expense" class="tab-content">
            <div class="sticky-header liquid-bg" style="padding: 10px; margin-bottom: 5px;">
                <div class="expense-dash glass" style="margin-bottom:0;">
                    <div class="total-twd" id="total-twd">NT$ 0</div>
                    <div class="total-jpy" id="total-jpy">Â¥ 0 (åŒ¯ç‡ 0.21)</div>
                </div>
            </div>
            
            <div class="expense-form">
                <input type="date" id="exp-date" class="input-glass" value="2026-03-12">
                <select id="exp-category" class="input-glass">
                    <option value="é£²é£Ÿ">ğŸ½ï¸ é£²é£Ÿ</option>
                    <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                    <option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨</option>
                    <option value="ç´€å¿µå“">ğŸ ç´€å¿µå“</option>
                    <option value="äº¤é€š">ğŸš† äº¤é€š</option>
                    <option value="å…¶ä»–">ğŸ“Œ å…¶ä»–</option>
                </select>
                <input type="number" id="exp-amount" class="input-glass" style="grid-column: span 2;" placeholder="è¼¸å…¥æ—¥å¹£é‡‘é¡ (Â¥)" pattern="\d*">
                <input type="hidden" id="edit-id" value="">
                <button class="btn-add" id="btn-save-exp" onclick="saveExpense()"><i class="fa-solid fa-check"></i> ç¢ºèªæ–°å¢</button>
            </div>
            <div id="expense-list-container"></div>
        </div>

        <!-- 4. åœ°åœ– Tab -->
        <div id="tab-map" class="tab-content">
            <div class="sticky-header liquid-bg">
                <div class="date-picker" id="date-picker-map"></div>
            </div>
            <div id="map-route-container" style="margin-top: 5px;"></div>
        </div>

        <!-- 5. æº–å‚™ Tab -->
        <div id="tab-planning" class="tab-content">
            <div class="check-group">
                <h3>ğŸ§´ ç”Ÿæ´»ç”¨å“</h3>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">è­·ç…§ & å¯¦é«”æ—¥å¹£</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">è­‰ä»¶ã€ä¿¡ç”¨å¡</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">å£ç½©</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">ä¹³æ¶²ã€åŒ–å¦æ°´ (åŒ–å¦åŒ…)</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">åˆ®é¬åˆ€</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">è¼•ä¾¿æ‹–é‹</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">é¦™æ°´</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">æ‘ºç–Šå‚˜</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">è¡›ç”Ÿç´™ / æ¿•ç´™å·¾</span></div>
            </div>
            <div class="check-group">
                <h3>ğŸ“± 3C ç”¢å“</h3>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">æ‰‹æ©Ÿ</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">è¡Œå‹•é›»æº (å¿…å¸¶æ”¾éš¨èº«)</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">å……é›»ç·š & è½‰æ¥é ­</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">ç›¸æ©Ÿ</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">é™å™ªè€³æ©Ÿ</span></div>
            </div>
            <div class="check-group">
                <h3>ğŸ‘• è¡£ç‰©</h3>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">è¡£æœ (æ›æ´—)</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">è¤²å­</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">ä¿æš–å¤–å¥— (æ´‹è”¥å¼ç©¿æ­)</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">å¸½å­ / é…ä»¶</span></div>
            </div>
            <div class="check-group">
                <h3>ğŸ§³ é›œé …</h3>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">å¸¸å‚™è—¥ / å°è­·å£« / é˜²èšŠæ¶²</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">å£“ç¸®è¢‹</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">å¤¾éˆè¢‹</span></div>
                <div class="check-item glass" onclick="this.classList.toggle('done')"><div class="check-box"></div><span class="check-text">è³¼ç‰©è¢‹</span></div>
            </div>
        </div>

    </div>

    <!-- Bottom Nav -->
    <nav>
        <div class="nav-item active" id="nav-schedule" onclick="switchTab('schedule', this)"><i class="fa-regular fa-calendar-check"></i><span>è¡Œç¨‹</span></div>
        <div class="nav-item" id="nav-bookings" onclick="switchTab('bookings', this)"><i class="fa-solid fa-ticket"></i><span>é è¨‚</span></div>
        <div class="nav-item" id="nav-expense" onclick="switchTab('expense', this)"><i class="fa-solid fa-yen-sign"></i><span>è¨˜å¸³</span></div>
        <div class="nav-item" id="nav-map" onclick="switchTab('map', this)"><i class="fa-solid fa-map-location-dot"></i><span>åœ°åœ–</span></div>
        <div class="nav-item" id="nav-planning" onclick="switchTab('planning', this)"><i class="fa-solid fa-suitcase-rolling"></i><span>æº–å‚™</span></div>
    </nav>
</div>

<script>
    // --- 1. å³æ™‚å¤©æ°£ API ---
    async function fetchWeather() {
        try {
            const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&current_weather=true&timezone=Asia%2FTokyo');
            const data = await res.json();
            const temp = Math.round(data.current_weather.temperature);
            const code = data.current_weather.weathercode;
            let emoji = 'â›…', advice = 'é©åˆå‡ºéŠï¼Œæ³¨æ„æ—©æ™šæº«å·®ã€‚';
            
            if(code === 0) { emoji = 'â˜€ï¸'; advice = 'æ™´æœ—å¥½å¤©æ°£ï¼å‡ºé–€è¨˜å¾—é˜²æ›¬ï¼Œæ¡æ´‹è”¥å¼ç©¿æ­ã€‚'; }
            else if(code <= 3) { emoji = 'â›…'; advice = 'å¤šé›²æ™‚æ™´ï¼Œæ°£å€™èˆ’é©ï¼Œéå¸¸é©åˆé€›è¡—æ•£æ­¥ã€‚'; }
            else if(code <= 67) { emoji = 'ğŸŒ§ï¸'; advice = 'é›¨å¤©ï¼å‡ºé–€å‹™å¿…æ”œå¸¶æ‘ºç–Šå‚˜ï¼Œå»ºè­°ç©¿é˜²æ°´é‹ã€‚'; }
            else if(code <= 77) { emoji = 'â„ï¸'; advice = 'ä¸‹é›ªæ©Ÿç‡é«˜ï¼Œè«‹ç©¿è‘—åšå¤–å¥—èˆ‡é˜²æ»‘é‹ä¿æš–ï¼'; }
            
            document.querySelector('.weather-top').innerHTML = `<span>ğŸ“ æ±äº¬å³æ™‚å¤©æ°£ (é»æ“Šçœ‹è©³æƒ…)</span><span style="color:var(--accent-color); font-size:16px;">${emoji} ${temp}Â°C</span>`;
            document.querySelector('.weather-desc').innerText = advice;
        } catch (e) {
            document.querySelector('.weather-desc').innerText = 'å¤©æ°£é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
        }
    }

    // --- 2. è¡Œç¨‹è³‡æ–™ (å…¨é¢æ“´å……ä¸¦å„ªåŒ–å‹•ç·š) ---
    const scheduleData = [
        {
            day: "Day 1", date: "3/12 (å››)", title: "æ·ºè‰ä¸‹ç”º",
            items: [
                { time: "06:15-10:35", title: "æ­ä¹˜ è™èˆª IT200", desc: "æ¡ƒåœ’(TPE) â†’ æˆç”°(NRT)" },
                { time: "11:20-12:10", title: "æ©Ÿå ´ç§»å‹•è‡³ä¸Šé‡", desc: "æ­ä¹˜ Skyliner (è»Šç¨‹ç´„41åˆ†) â†’ äº¬æˆä¸Šé‡", tip: "äº¬æˆä¸Šé‡ç«™å‡ºä¾†å°±æ˜¯ä¸å¿æ± ï¼Œèµ°åˆ°é£¯åº—å¯„æ”¾è¡Œæç´„5-7åˆ†ã€‚", nav: "äº¬æˆä¸Šé‡ç«™åˆ°APAé£¯åº—" },
                { time: "12:30-13:30", title: "åˆé¤ï¼šä¸Šé‡å‘¨é‚Š", desc: "æ¨è–¦ï¼šåä»£å®‡å¥ˆã¨ã¨ (é°»é­šé£¯) æˆ– é´¨toè”¥æ‹‰éºµ" },
                { 
                    time: "13:30-16:30", title: "æ·ºè‰å·¡ç¦®", desc: "åœ°éµï¼šéŠ€åº§ç·š ä¸Šé‡ â†’ æ·ºè‰ 1è™Ÿå‡ºå£",
                    subSpots: [
                        { name: "æ·ºè‰æ–‡åŒ–è§€å…‰ä¸­å¿ƒ", desc: "8æ¨“å…è²»å±•æœ›å°ï¼Œå¯æ‹é›·é–€å…¨æ™¯èˆ‡æ™´ç©ºå¡”ã€‚", nav: "æ·ºè‰æ–‡åŒ–è§€å…‰ä¸­å¿ƒ" },
                        { name: "æ·ºè‰é›·é–€ & ä»²è¦‹ä¸–é€š", desc: "å…¥å¯ºè«‹å…ˆåœ¨é›·é–€å‰é èº¬ï¼Œèµ°åƒé“å…©å´ï¼Œæ‰‹æ°´èˆæ´—æ‰‹å¾Œå†åƒæ‹œã€‚", nav: "æ·ºè‰é›·é–€", link: "https://www.senso-ji.jp/" },
                        { name: "ã‚ˆã‚ã—åŒ–ç²§å ‚ ä»²è¦‹ä¸–åº—", desc: "æ¨è–¦è³¼è²· 365 å¤©ç”Ÿæ—¥è­·æ‰‹éœœã€‚", nav: "ã‚ˆã‚ã—åŒ–ç²§å ‚ ä»²è¦‹ä¸–åº—" },
                        { name: "é›·ä¸€èŒ¶ ãŠæŠ¹èŒ¶ä½“é¨“åº—", desc: "å“åšæ¿ƒéƒæŠ¹èŒ¶ç”œé»ã€‚", nav: "é›·ä¸€èŒ¶ æµ…è‰æœ¬åº—" },
                        { name: "å£½ã€…å–œåœ’", desc: "ä¸–ç•Œæœ€æ¿ƒæŠ¹èŒ¶å†°æ·‡æ·‹ï¼è¨˜å¾—è¦è²·æŠ¹èŒ¶ç²‰å›å»ã€‚", nav: "å£½ã€…å–œåœ’ æµ…è‰æœ¬åº—" }
                    ]
                },
                { time: "16:30-17:00", title: "ç§»å‹•è‡³æ™´ç©ºå¡”", desc: "æ­¥è¡Œèµ° SUMIDA RIVER WALK (ç´„20åˆ†)", tip: "æ²¿é€”å¯æ‹æ”æ™´ç©ºå¡”èˆ‡æœæ—¥å•¤é…’é‡‘è‰²ä¾¿ä¾¿ğŸ’©ã€‚ä¸æƒ³èµ°ä¹Ÿå¯æ­æ·ºè‰ç·šåªéœ€3åˆ†é˜ç›´é”æŠ¼ä¸Šç«™ï¼", nav: "æ·ºè‰åˆ°æ™´ç©ºå¡”" },
                { 
                    time: "17:00-19:00", title: "æ±äº¬æ™´ç©ºå¡”", desc: "ã€å·²è¨‚ç¥¨ 17:00 å…¥å ´ã€‘",
                    subSpots: [
                        { name: "å±•æœ›å° (Tembo Deck)", desc: "3æœˆä¸­æ—¥è½æ™‚é–“ç´„ 17:45ï¼Œå¯åŒæ™‚çœ‹æ—¥è½èˆ‡å¤œæ™¯ã€‚", nav: "æ±äº¬æ™´ç©ºå¡”", link: "https://www.tokyo-skytree.jp/tw/" },
                        { name: "å¯¶å¯å¤¢ä¸­å¿ƒ (East Yard 4F)", desc: "å¿…è²·ï¼šæ™´ç©ºå¡”é™å®šã€ŒæŠ±è‘—çƒˆç©ºåçš„çš®å¡ä¸˜ã€å¨ƒå¨ƒï¼", nav: "Pokemon Center Skytree" }
                    ]
                },
                { time: "19:00-20:30", title: "æ™šé¤ï¼šSolamachiå•†å ´", desc: "å…­å˜èˆæ²¾éºµ / åˆ©ä¹…ç‰›èˆŒ" },
                { 
                    time: "20:30-", title: "è¿”å›ä¸Šé‡ / æ™šé–“æ´»å‹•", desc: "åœ°éµï¼šæŠ¼ä¸Š â†’ ä¸Šé‡",
                    subSpots: [
                        { name: "æ·ºè‰å¯º å¤œé–“é»ç‡ˆ", desc: "å›ç¨‹å¯é †è·¯ç¹å»æ‹æ²’äººçš„é›·é–€å¤œæ™¯ã€‚", nav: "æ·ºè‰å¯º" },
                        { name: "æµ…è‰ROXã¾ã¤ã‚Šæ¹¯", desc: "ç‡Ÿæ¥­è‡³éš”æ—¥ 09:00ï¼Œå¯æ³¡æ¹¯æ”¾é¬†ã€‚", nav: "æµ…è‰ROXã¾ã¤ã‚Šæ¹¯", link: "https://www.matsuri-yu.com/" },
                        { name: "æ²»ä¸€éƒ è²·å¸ƒä¸", desc: "Ecuteä¸Šé‡åº—å…§ã€‚æ³¨æ„ç‡Ÿæ¥­æ™‚é–“åªåˆ° 22:00ï¼", nav: "æ²»ä¸€éƒ ecuteä¸Šé‡åº—" },
                        { name: "å”å‰è¨¶å¾· å¾¡å¾’ç”ºåº—", desc: "ç¡ä¸è‘—å¯å»é€›ï¼Œç‡Ÿæ¥­è‡³åŠå¤œ 1:00ã€‚", nav: "å”å‰è¨¶å¾· å¾¡å¾’ç”ºåº—" }
                    ]
                }
            ],
            mapStops: ["äº¬æˆä¸Šé‡ç«™", "æ·ºè‰é›·é–€", "SUMIDA RIVER WALK", "æ±äº¬æ™´ç©ºå¡”", "å”å‰è¨¶å¾· å¾¡å¾’ç”ºåº—"]
        },
        {
            day: "Day 2", date: "3/13 (äº”)", title: "æ½®æµæ¾€è°·",
            items: [
                { 
                    time: "08:00-09:45", title: "ä¸­ç›®é»‘ / ä»£å®˜å±±æ™¨é–“æ•£æ­¥", desc: "åœ°éµï¼šæ—¥æ¯”è°·ç·š ä¸Šé‡ â†’ ä¸­ç›®é»‘",
                    subSpots: [
                        { name: "æ˜Ÿå·´å…‹è‡»é¸Â® æ±äº¬çƒ˜ç„™å·¥åŠ", desc: "07:00é–‹é–€ã€‚æƒQRæŠ½è™Ÿç¢¼ç‰Œã€‚å¯é»æ“Šå³æ–¹æŸ¥çœ‹æ¨è–¦èœå–®ã€‚", nav: "æ˜Ÿå·´å…‹è‡»é¸æ±äº¬çƒ˜ç„™å·¥åŠ", photo: "https://drive.google.com/file/d/1yOb2W329fnoTHgSk5bCYtWdIqYspAqD6/view?usp=drive_link" },
                        { name: "ä»£å®˜å±± T-SITE (è”¦å±‹æ›¸åº—)", desc: "09:00é–‹é–€ï¼Œä¸–ç•Œæœ€ç¾æ›¸åº—ä¹‹ä¸€ã€‚", nav: "ä»£å®˜å±± T-SITE" },
                        { name: "Iâ€™m donut ? Nakameguro", desc: "10:00é–‹é–€ï¼Œè¶…äººæ°£ç”Ÿç”œç”œåœˆï¼Œéœ€æœ‰æ’éšŠå¿ƒç†æº–å‚™ã€‚", nav: "Iâ€™m donut ? ä¸­ç›®é»‘" }
                    ]
                },
                { time: "09:45-10:30", title: "æ˜æ²»ç¥å®®", desc: "åƒæ‹œæµç¨‹ï¼šé³¥å±…å‰ä¸€é èº¬ â†’ èµ°åƒé“å…©å´ â†’ æ´—æ‰‹æ¼±å£ â†’ æ‹œæ®¿ã€ŒäºŒé èº¬ã€äºŒæ‹æ‰‹ã€ä¸€é èº¬ã€", nav: "æ˜æ²»ç¥å®®", link: "https://www.meijijingu.or.jp/guide/" },
                { 
                    time: "10:30-13:30", title: "åŸå®¿è¡¨åƒé“é€›è¡—", desc: "æ³¨æ„ï¼šå¤šæ•¸åº—å®¶ 11:00 é–‹é–€",
                    subSpots: [
                        { name: "ä¼Šè‰¯å¯æ¨‚ æ¸‹è°·ç¥å®®å‰", desc: "æ—¥æœ¬è¶…ç´…æ‰‹å·¥ç²¾é‡€å¯æ¨‚ã€‚", nav: "ä¼Šè‰¯å¯æ¨‚ æ¸‹è°·ç¥å®®å‰" },
                        { name: "#C-pla+ åŸå®¿ç«¹ä¸‹é€šåº—", desc: "09:30é–‹é–€ï¼Œè¶…å¤§æ‰­è›‹åº—å¯å…ˆé€›ã€‚", nav: "#C-pla åŸå®¿" },
                        { name: "and ST (æ——è‰¦åº—)", desc: "11:00é–‹é–€ï¼ŒåŸå®¿ç«™å‡ºå£å°é¢ã€‚", nav: "and ST åŸå®¿" },
                        { name: "æ±æ€¥å»£å ´ åŸè§’ (HARAKADO)", desc: "å¹³ç”°æ™ƒä¹…è¨­è¨ˆï¼Œå¦‚ã€Œç·¨ç¹”ã€èˆ¬çš„ä¸è¦å‰‡ç»ç’ƒå¸·å¹•ï¼Œé ‚æ¨“æœ‰è¶…ç¾æˆ¶å¤–éœ²è‡ºã€‚", nav: "æ±æ€¥ãƒ—ãƒ©ã‚¶åŸå®¿ã€Œãƒãƒ©ã‚«ãƒ‰ã€" },
                        { name: "NUMBER SUGAR", desc: "11:00é–‹é–€ã€‚æ¨è–¦ï¼šNo.1é¦™è‰ã€No.2æµ·é¹½ã€‚", nav: "NUMBER SUGAR è¡¨åƒé“" },
                        { name: "è¡¨åƒé“ä¹‹ä¸˜", desc: "å®‰è—¤å¿ é›„è¨­è¨ˆï¼Œæ–œå¡èµ°é“èˆ‡æŒ‘é«˜ç©ºé–“æ˜¯æ‹ç…§äº®é»ã€‚", nav: "è¡¨åƒé“ä¹‹ä¸˜" },
                        { name: "BEAMS & HOKA åŸå®¿", desc: "éƒ½åœ¨é™„è¿‘ï¼Œå¯é †è·¯é€›ã€‚", nav: "BEAMS åŸå®¿" }
                    ]
                },
                { time: "13:30-14:30", title: "åˆé¤ï¼šSuage æ¹¯å’–å“© æ¾€è°·åº—", desc: "ææ—©åƒé¿é–‹å°–å³°ã€‚æ¨è–¦å¿…åŠ é»ã€Œç‚¸èŠ±æ¤°èœã€ã€‚", nav: "Suageæ¾€è°·åº—" },
                { 
                    time: "14:30-18:00", title: "ç¥å—å€èˆ‡æ¾€è°·é€›è¡—", desc: "æ²¿é€”ä¸€è·¯å¾€å—é€›å›è»Šç«™",
                    subSpots: [
                        { name: "FREAK'S STORE Shibuya", desc: "ç¥å—å€æ½®æµé¸ç‰©åº—ã€‚", nav: "FREAK'S STORE æ¾€è°·" },
                        { name: "HOKA æ¾€è°·", desc: "è‹¥åŸå®¿æ²’è²·åˆ°å¯ä¾†é€™ã€‚", nav: "HOKA Shibuya" },
                        { name: "BEAMS JAPAN æ¾€è°·", desc: "æ±æ€¥Plaza 2Fï¼Œè²©å”®è¨±å¤šæ—¥æœ¬é™å®šä¼´æ‰‹ç¦®ã€‚", nav: "BEAMS JAPAN æ¾€è°·" },
                        { name: "ä»»å¤©å ‚ æ±äº¬æ——è‰¦åº— ğŸ„", desc: "ä½æ–¼ PARCO 6Fã€‚", nav: "Nintendo TOKYO" },
                        { name: "å¯¶å¯å¤¢ä¸­å¿ƒ ğŸ”´", desc: "ä½æ–¼ PARCO 6Fï¼Œé–€å£æœ‰è¶…å¸¥è¶…å¤¢ã€‚", nav: "Pokemon Center Shibuya" }
                    ]
                },
                { time: "18:00-", title: "æ¾€è°·åå­—è·¯å£ & æ™šé¤", desc: "æ‹ç…§å¾Œåƒæ™šé¤", tip: "å…é ç´„æ™šé¤æ¨è–¦ï¼šæ¾€è°·è¥¿æ­¦ç™¾è²¨8Fã€Œæ´»ç¾ç™»åˆ© è¿´è½‰å£½å¸ã€(ç¿»æ¡Œå¿«) æˆ– å›ä¸Šé‡åƒã€Œå±±å®¶ç‚¸è±¬æ’ã€(é«˜CPå€¼)ã€‚", nav: "æ¾€è°·åå­—è·¯å£" }
            ],
            mapStops: ["æ˜Ÿå·´å…‹è‡»é¸æ±äº¬çƒ˜ç„™å·¥åŠ", "æ˜æ²»ç¥å®®", "NUMBER SUGAR è¡¨åƒé“", "Suage æ¾€è°·åº—", "æ¾€è°· PARCO"]
        },
        {
            day: "Day 3", date: "3/14 (å…­)", title: "æ± è¢‹æ–°å®¿",
            items: [
                { 
                    time: "10:00-13:00", title: "æ± è¢‹ Sunshine City", desc: "JRå±±æ‰‹ç·šå‰å¾€",
                    subSpots: [
                        { name: "å¯¶å¯å¤¢ä¸­å¿ƒ MEGA TOKYO", desc: "æ——è‰¦åº—ç´šåˆ¥ã€‚", nav: "Pokemon Center Mega Tokyo" },
                        { name: "è½‰è›‹çš„æ£®æ— (ç¸½æœ¬åº—)", desc: "è¶…å¤§å‹æ‰­è›‹æ¨‚åœ’ã€‚", nav: "ã‚¬ã‚·ãƒ£ãƒãƒ³ã®ãƒ‡ãƒ‘ãƒ¼ãƒˆæ± è¢‹ç·æœ¬åº—" }
                    ]
                },
                { time: "13:00-14:00", title: "åˆé¤ï¼šæ± è¢‹å‘¨é‚Š", desc: "æ¨è–¦ï¼šMiurano Hamburg (æ¼¢å ¡æ’) / ç„¡æ•µå®¶æ‹‰éºµ / å¤ªé™½åŸå…§ å¤©éº©ç¾… ç¶²å…«", nav: "ä¸‰æµ¦ã®ãƒãƒ³ãƒãƒ¼ã‚° æ± è¢‹" },
                { 
                    time: "14:00-16:30", title: "æ–°å®¿é€›è¡—", desc: "JRå±±æ‰‹ç·šï¼šæ± è¢‹ â†’ æ–°å®¿",
                    subSpots: [
                        { name: "LUMINE EST æ–°å®¿ (B1)", desc: "è²· Pensta (ä¼éµå‘¨é‚Š)ã€‚", nav: "LUMINE EST" },
                        { name: "ä¼Šå‹¢ä¸¹æ–°å®¿åº— ç”·å£«é¤¨", desc: "æ—¥æœ¬æœ€å¼·ç”·è£ç™¾è²¨ã€‚", nav: "ä¼Šå‹¢ä¸¹ æ–°å®¿åº— ç”·é¤¨" },
                        { name: "KIDDY LAND æ–°å®¿åº—", desc: "å‹•æ¼«å‘¨é‚Šã€‚", nav: "KIDDY LAND æ–°å®¿" },
                        { name: "BEAMS JAPAN æ–°å®¿", desc: "1-5Fè²©å”®æ—¥æœ¬åœ°æ–¹ç‰¹è‰²èˆ‡æœé£¾ã€‚", nav: "BEAMS JAPAN æ–°å®¿" },
                        { name: "KEN BOX", desc: "è¿·ä½ è»Šæ¨¡å‹å°ˆè³£åº—ã€‚", nav: "ãƒŸãƒ‹ã‚«ãƒ¼ã‚·ãƒ§ãƒƒãƒ— ã‚±ãƒ³ãƒœãƒƒã‚¯ã‚¹" },
                        { name: "æ–°å®¿æ±å¯¶å¤§æ¨“", desc: "æ‹æ”å“¥å‰æ‹‰å¤§é ­ã€‚", nav: "æ–°å®¿æ±å®ãƒ“ãƒ«" },
                        { name: "æ±æ€¥æ­Œèˆä¼ç”ºTOWER", desc: "æ–°å®¿æ–°åœ°æ¨™ï¼Œçµåˆéœ“è™¹å±…é…’å±‹èˆ‡å¨›æ¨‚ã€‚", nav: "æ±æ€¥æ­Œèˆä¼ç”ºã‚¿ãƒ¯ãƒ¼" }
                    ]
                },
                { time: "16:30-17:30", title: "æ™šé¤ï¼šæ–°å®¿å‘¨é‚Š", desc: "æ¨è–¦(å…é ç´„)ï¼šæ… Udon (çƒé¾éºµï¼Œå…ˆæŠ½åˆ¸) / é¾ä¹‹å®¶æ‹‰éºµ / é³¥è²´æ— æ–°å®¿å—å£åº—" },
                { time: "17:30-19:00", title: "æ±äº¬éƒ½å»³ å—å±•æœ›å®¤", desc: "å…è²»çœ‹æ—¥è½èˆ‡å¤œæ™¯ã€‚", link: "https://www.zaimu.metro.tokyo.lg.jp/tochousha/goannai/tenbou", nav: "æ±äº¬éƒ½å»³" },
                { time: "19:00-20:30", title: "TOKYO Night & Light", desc: "éƒ½å»³å…‰é›•ç§€ï¼š19:00 é‹¼å½ˆ / 20:00 å“¥å‰æ‹‰", link: "https://tokyoprojectionmappingproject.jp/", nav: "éƒ½æ°‘å»£å ´" },
                { time: "20:30-", title: "é«”é©—æ­Œèˆä¼ç”ºå¤œç”Ÿæ´»", desc: "æ„Ÿå—ç†±é¬§æ°£æ°›å¾Œè¿”å›é£¯åº—", nav: "æ­Œèˆä¼ç”ºä¸€ç•ªè¡—" }
            ],
            mapStops: ["æ± è¢‹å¤ªé™½åŸ", "LUMINE EST", "ä¼Šå‹¢ä¸¹ æ–°å®¿åº—", "æ±äº¬éƒ½å»³", "æ­Œèˆä¼ç”ºä¸€ç•ªè¡—"]
        },
        {
            day: "Day 4", date: "3/15 (æ—¥)", title: "å¼·é‹éŠ€åº§",
            items: [
                { time: "07:30-08:00", title: "å‰å¾€å°ç¶²ç¥ç¤¾", desc: "äº¤é€šï¼šåœ°éµæ—¥æ¯”è°·ç·š ä¸Šé‡ â†’ äººå½¢ç”º (ç´„15åˆ†)" },
                { time: "08:00-08:30", title: "å°ç¶²ç¥ç¤¾", desc: "å¼·é‹é™¤å„/æ´—éŒ¢", tip: "æ´—éŒ¢è«‹è‡ªå‚™é›¶éŒ¢æˆ–ç´™éˆ”ï¼Œæ´—å®Œæ“¦ä¹¾æ”¾éŒ¢åŒ…ç•¶ã€ŒéŒ¢æ¯ã€ã€‚åƒæ‹œï¼šäºŒé èº¬ã€äºŒæ‹æ‰‹ã€ä¸€é èº¬ã€‚", nav: "å°ç¶²ç¥ç¤¾" },
                { 
                    time: "08:30-09:30", title: "æ—¥æœ¬æ©‹æ•£æ­¥ & å¯¶å¯å¤¢ DX", desc: "æ­¥è¡Œå‰å¾€",
                    subSpots: [
                        { name: "æ—¥æœ¬æ©‹ éº’éºŸåƒ", desc: "æ±é‡åœ­å¾å°èªªå ´æ™¯ï¼Œæ‹é’éŠ…éº’éºŸã€‚", nav: "æ—¥æœ¬æ©‹ éº’éºŸåƒ" },
                        { name: "å¯¶å¯å¤¢ä¸­å¿ƒ æ±äº¬ DX", desc: "çµåˆå¯¶å¯å¤¢å’–å•¡å»³çš„è¶…å¤§åº—é‹ªã€‚", nav: "Pokemon Center Tokyo DX" }
                    ]
                },
                { 
                    time: "09:30-11:30", title: "æ±äº¬è»Šç«™ä¸€ç•ªè¡—", desc: "å…«é‡æ´²ä¸­å¤®å£ä¸‹æ¨“ â†’ åŒ—å£å·¦è½‰",
                    subSpots: [
                        { name: "æ±äº¬å‹•æ¼«äººç‰©è¡—", desc: "å„é›»è¦–å°å‘¨é‚Šã€å‰åœåŠ›å°ˆè³£åº—ã€‚", nav: "æ±äº¬å‹•æ¼«äººç‰©è¡—" }
                    ]
                },
                { time: "12:00-13:30", title: "åˆé¤ï¼šç‡’è‚‰ Ushigoro", desc: "ã€å·²é ç´„ 12:00ã€‘éŠ€åº§1-6-6", nav: "Ushigoro Ginza" },
                { 
                    time: "13:30-16:00", title: "éŠ€åº§æ­¥è¡Œè€…å¤©åœ‹", desc: "é€±æœ«å°è¡—",
                    subSpots: [
                        { name: "ç„¡å°è‰¯å“ éŠ€åº§æ——è‰¦åº—", desc: "ä¸–ç•Œç´šæ——è‰¦åº—ï¼Œæœ‰å°ˆå±¬ç”Ÿé®®èˆ‡çƒ˜ç„™åŠã€‚", nav: "ç„¡å°è‰¯å“ éŠ€åº§" },
                        { name: "Ginza Sony Park", desc: "éƒ½å¸‚ç«‹é«”å…¬åœ’ï¼Œé©åˆæ‹ç…§æ‰“å¡ã€‚", nav: "Ginza Sony Park" },
                        { name: "GINZA SIX", desc: "éŠ€åº§æœ€å¤§å•†æ¥­è¨­æ–½ï¼ŒæŒ‘é«˜ä¸­åº­æœ‰å¤§å¸«è£ç½®è—è¡“ã€‚", nav: "GINZA SIX" },
                        { name: "3COINS & UNIQLO", desc: "é€›ç”Ÿæ´»é›œè²¨èˆ‡å®¢è£½åŒ–è¡£æœã€‚", nav: "UNIQLO éŠ€åº§" }
                    ]
                },
                { 
                    time: "16:00-18:30", title: "ç§‹è‘‰åŸ", desc: "é›»å™¨è¡—èˆ‡æ¬¡æ–‡åŒ–",
                    subSpots: [
                        { name: "KENELE STAND", desc: "ç§‹è‘‰åŸè»Šç«™å…§çš„ç²¾ç·»æ‰­è›‹ç‰†ã€‚", nav: "KENELE STAND ç§‹è‘‰åŸ" },
                        { name: "Bic Camera ç§‹è‘‰åŸ", desc: "ç‡Ÿæ¥­æ™‚é–“ 10:00â€“21:00ã€‚", nav: "Bic Camera ç§‹å¶åŸåº—" },
                        { name: "Milk Shop LUCK é…ª", desc: "ç¸½æ­¦ç·š6è™Ÿæœˆå°ä¸Šçš„ç‰›å¥¶åº—ï¼Œå–å®Œç»ç’ƒç“¶è¦é‚„çµ¦é˜¿å§¨ã€‚", nav: "Milk Shop LUCK é…ª", link: "https://tokyo.letsgojp.com/archives/570282/" }
                    ]
                },
                { time: "18:30-19:30", title: "æ±äº¬è»Šç«™ å¤œæ™¯", desc: "æ‹æ”é»ï¼šä¸¸ä¹‹å…§ç«™å‰å»£å ´ / KITTE 6F (ç‡Ÿæ¥­è‡³22:00)ã€‚", nav: "KITTEä¸¸ä¹‹å…§" },
                { time: "19:30-", title: "æ™šé¤ï¼šæ±äº¬è»Šç«™å‘¨é‚Š", desc: "æ¨è–¦åå–®ï¼šç”Ÿãƒ‘ã‚¹ã‚¿å°‚é–€åº— éº¦ã¨åµ / æ¥µå‘³å±‹ æ±äº¬ç«™åº— / å…­å˜èˆæ²¾éºµ (æ‹‰éºµè¡—) / æ ¹å®¤èŠ±ä¸¸è¿´è½‰å£½å¸ (KITTEå…§)" }
            ],
            mapStops: ["å°ç¶²ç¥ç¤¾", "Pokemon Center Tokyo DX", "Ushigoro Ginza", "ç„¡å°è‰¯å“ éŠ€åº§", "KITTEä¸¸ä¹‹å…§"]
        },
        {
            day: "Day 5", date: "3/16 (ä¸€)", title: "éº»å¸ƒå°è—è¡“",
            items: [
                { time: "08:15-09:00", title: "å‰å¾€ TeamLab", desc: "åœ°éµæ—¥æ¯”è°·ç·š ä¸Šé‡ â†’ ç¥è°·ç”º (5è™Ÿå‡ºå£)" },
                { time: "09:00-11:00", title: "TeamLab Borderless", desc: "ã€å·²è¨‚ç¥¨ 09:00 å…¥å ´ã€‘", nav: "éº»å¸ƒå°ä¹‹ä¸˜" },
                { 
                    time: "11:00-12:00", title: "éº»å¸ƒå°ä¹‹ä¸˜", desc: "æ£®JP Tower", link: "https://www.azabudai-hills.com/index.html",
                    subSpots: [
                        { name: "33F Sky Lobby (çœºæœ›æ±äº¬éµå¡”)", desc: "æ³¨æ„ï¼šéœ€æ–¼ Hills House Sky Room Cafe & Bar é»å’–å•¡æˆ–å°é»æ‰èƒ½é€²å…¥ã€‚", nav: "éº»å¸ƒå°ä¹‹ä¸˜", link: "https://tokyo.letsgojp.com/archives/632958/" }
                    ]
                },
                { time: "12:00-13:00", title: "åˆé¤ï¼šé°»ã®æˆç€¬ å…­æœ¬æœ¨åº—", desc: "é«˜CPå€¼é°»é­šé£¯", nav: "é°»ã®æˆç€¬ å…­æœ¬æœ¨åº—" },
                { 
                    time: "13:00-15:30", title: "å…­æœ¬æœ¨ & åœ‹ç«‹æ–°ç¾è¡“é¤¨", desc: "æ•£ç­–",
                    subSpots: [
                        { name: "åœ‹ç«‹æ–°ç¾è¡“é¤¨", desc: "é»‘å·ç´€ç« è¨­è¨ˆï¼Œæ³¢æµªç»ç’ƒå¸·å¹•èˆ‡åœ“éŒå½¢å…¥å£ï¼Œæ¥µå…·æœªä¾†æ„Ÿï¼Œé©åˆæ‹ç…§ã€‚", nav: "åœ‹ç«‹æ–°ç¾è¡“é¤¨", link: "https://www.nact.jp/" },
                        { name: "å…­æœ¬æœ¨ä¹‹ä¸˜", desc: "å¤§èœ˜è››é›•å¡‘ (Maman)ã€æ¯›åˆ©åº­åœ’ã€‚", nav: "å…­æœ¬æœ¨ä¹‹ä¸˜" }
                    ]
                },
                { 
                    time: "16:00-18:30", title: "ä¸Šé‡ é˜¿ç¾æ©«ä¸", desc: "æœ€å¾Œæ¡è²·",
                    subSpots: [
                        { name: "Yamashiroya ç©å…·åº—", desc: "å…­å±¤æ¨“ç©å…·å¤©å ‚ï¼Œå°±åœ¨è»Šç«™å°é¢ã€‚", nav: "Yamashiroya" },
                        { name: "OS Drug ä¸Šé‡åº—", desc: "è¶…ä¾¿å®œè—¥å¦ï¼æ³¨æ„ï¼šåªæ”¶ç¾é‡‘ï¼Œç„¡å…ç¨…ã€‚", nav: "OS Drug ä¸Šé‡" },
                        { name: "äºŒæœ¨è“å­", desc: "è²·ä¼´æ‰‹ç¦®ã€‚æ³¨æ„æ‰“çƒŠæ™‚é–“ï¼š20:00ã€‚", nav: "äºŒæœ¨è“å­ ç¬¬ä¸€ç‡Ÿæ¥­æ‰€" }
                    ]
                },
                { time: "18:30-19:30", title: "æ™šé¤ï¼šä¸Šé‡å‘¨é‚Š", desc: "å‚™é¸åå–®ï¼šé³¥è²´æ— ä¸Šé‡ä¸­å¤®é€šåº— / è‚‰çš„å¤§å±± (ç‚¸è‚‰é¤…) / å±±å®¶ç‚¸è±¬æ’ / ç£¯ä¸¸æ°´ç”¢ (24H)" },
                { time: "19:30-20:00", title: "å›é£¯åº—æ”¾æ±è¥¿", desc: "æ¸›è¼•è² æ“”å†å‡ºé–€" },
                { time: "20:00-", title: "èŠå…¬åœ’ æ‹æ”æ±äº¬éµå¡”", desc: "å‰å¾€ 7-Eleven æ¸¯å€èŠ3ä¸ç›®åº— æ‹æ”è¶…ç¾éµå¡”å¤œæ™¯", nav: "7-Eleven æ¸¯åŒºèŠ3ä¸ç›®åº—" }
            ],
            mapStops: ["éº»å¸ƒå°ä¹‹ä¸˜", "åœ‹ç«‹æ–°ç¾è¡“é¤¨", "é˜¿ç¾æ©«ä¸", "é³¥è²´æ— ä¸Šé‡", "7-Eleven æ¸¯åŒºèŠ3ä¸ç›®åº—"]
        },
        {
            day: "Day 6", date: "3/17 (äºŒ)", title: "è¿”ç¨‹",
            items: [
                { 
                    time: "09:30-10:00", title: "é€€æˆ¿ & å¯„æ”¾è¡Œæ", desc: "âš ï¸æ¥µé‡è¦ï¼šè«‹ç›¡æ—©å»æ¶äº¬æˆä¸Šé‡ç«™ç½®ç‰©æ«ƒã€‚",
                    subSpots: [
                        { name: "äº¬æˆä¸Šé‡ç«™ ç½®ç‰©æ«ƒ", desc: "ä½æ–¼ Skyliner å‰ªç¥¨å£æ—ï¼Œå¾€ä¸Šé‡å‹•ç‰©åœ’ã€ä¸Šé‡æ©è³œå…¬åœ’å‡ºå£æ–¹å‘ã€‚", nav: "äº¬æˆä¸Šé‡ç«™", link: "https://marifoodie.com/ueno-station-lockers/" }
                    ]
                },
                { time: "10:00-11:15", title: "ä¸Šé‡æ©è³œå…¬åœ’", desc: "æ•£æ­¥ / Coffee Murasaki", nav: "ä¸Šé‡æ©è³œå…¬åœ’" },
                { time: "11:30-12:45", title: "åˆé¤ï¼šäººå½¢ç”ºä»ŠåŠ", desc: "ã€å·²é ç´„ 11:30ã€‘", nav: "äººå½¢ç”ºä»ŠåŠ ä¸Šé‡å»£å°è·¯åº—" },
                { time: "13:00-13:45", title: "æ­ä¹˜ Skyliner å‰å¾€æ©Ÿå ´", desc: "13:00ç™¼è»Šï¼Œâš ï¸æ¥µé™ç­æ¬¡13:20" },
                { time: "15:40-", title: "æ­ä¹˜ æ˜Ÿå®‡ JX803 è¿”å°", desc: "æˆç”°(NRT) â†’ æ¡ƒåœ’(TPE)" }
            ],
            mapStops: ["äº¬æˆä¸Šé‡ç«™", "ä¸Šé‡æ©è³œå…¬åœ’", "äººå½¢ç”ºä»ŠåŠ ä¸Šé‡å»£å°è·¯åº—", "æˆç”°æ©Ÿå ´"]
        }
    ];

    window.onload = () => {
        fetchWeather();
        renderDateChips();
        selectDay(0, 'schedule');
        selectDay(0, 'map');
        renderExpenses();
    };

    // --- Tab åˆ‡æ›èˆ‡éš±è—å¤©æ°£ ---
    function switchTab(tabId, element) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(`tab-${tabId}`).classList.add('active');
        element.classList.add('active');

        const weatherObj = document.getElementById('weather-display');
        if(tabId === 'expense' || tabId === 'planning') {
            weatherObj.style.display = 'none';
        } else {
            weatherObj.style.display = 'block';
        }
    }

    // è·¨é é¢è·³è½‰è‡³é è¨‚
    function jumpToBookings() {
        document.getElementById('nav-bookings').click();
    }

    function renderDateChips() {
        const schedContainer = document.getElementById('date-picker-schedule');
        const mapContainer = document.getElementById('date-picker-map');
        
        scheduleData.forEach((day, index) => {
            const createChip = (container, type) => {
                const chip = document.createElement('div');
                chip.className = `date-chip ${index === 0 ? 'active' : ''}`;
                chip.innerHTML = `${day.day}<br><span style="font-weight:400; font-size:11px;">${day.date}</span>`;
                chip.onclick = () => {
                    container.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    selectDay(index, type);
                };
                container.appendChild(chip);
            };
            createChip(schedContainer, 'schedule');
            createChip(mapContainer, 'map');
        });
    }

    // å°‡å°èˆªé€£çµçµ±ä¸€é è¨­ç‚ºã€Œå¤§çœ¾é‹è¼¸ (transit)ã€
    function getTransitMapUrl(destination) {
        return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destination)}&travelmode=transit`;
    }

    function formatText(text) {
        return text
            .replace(/ã€å·²è¨‚ç¥¨(.*?)ã€‘/g, '<span class="highlight-ticket" onclick="jumpToBookings()"><i class="fa-solid fa-ticket"></i> ã€å·²è¨‚ç¥¨$1ã€‘</span>')
            .replace(/ã€å·²é ç´„(.*?)ã€‘/g, '<span class="highlight-reserve" onclick="jumpToBookings()"><i class="fa-solid fa-bell-concierge"></i> ã€å·²é ç´„$1ã€‘</span>');
    }

    function selectDay(index, type) {
        const data = scheduleData[index];
        if (type === 'schedule') {
            document.getElementById('day-title').innerText = `ğŸ“Œ ${data.title}`;
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';
            
            data.items.forEach(item => {
                let catClass = 'cat-attraction';
                if (/æ­ä¹˜|ç§»å‹•|Skyliner|åœ°éµ|æ­¥è¡Œ|å‰å¾€|è¿”å›|é€€æˆ¿/.test(item.title)) catClass = 'cat-transport';
                if (/åˆé¤|æ™šé¤|æ˜Ÿå·´å…‹|ç‡’è‚‰|æ²¾éºµ|ä»ŠåŠ|ç”œç”œåœˆ|å¸ƒä¸/.test(item.title + item.desc)) catClass = 'cat-food';
                if (/âš ï¸/.test(item.title + item.desc + item.tip)) catClass = 'cat-alert';

                // ä¸»å±¤å°èˆª (ä½¿ç”¨ getTransitMapUrl)
                const mainNav = item.nav ? `<a href="${getTransitMapUrl(item.nav)}" target="_blank" class="nav-btn"><i class="fa-solid fa-location-arrow" style="color:var(--tag-transport);"></i> å°èˆª</a>` : '';
                const mainLink = item.link ? `<a href="${item.link}" target="_blank" class="nav-btn external"><i class="fa-solid fa-link"></i> æŒ‡å—</a>` : '';
                const tipHtml = item.tip ? `<div class="tip-box"><i class="fa-solid fa-lightbulb"></i><div>${item.tip}</div></div>` : '';
                
                let subSpotsHtml = '';
                if (item.subSpots && item.subSpots.length > 0) {
                    const spotsList = item.subSpots.map(spot => {
                        const spotNav = spot.nav ? `<a href="${getTransitMapUrl(spot.nav)}" target="_blank" class="nav-btn"><i class="fa-solid fa-location-dot"></i></a>` : '';
                        const spotLink = spot.link ? `<a href="${spot.link}" target="_blank" class="nav-btn external"><i class="fa-solid fa-link"></i></a>` : '';
                        const spotPhoto = spot.photo ? `<a href="${spot.photo}" target="_blank" class="nav-btn photo"><i class="fa-solid fa-camera"></i> èœå–®</a>` : '';
                        
                        return `
                        <div class="sub-spot-item">
                            <div class="sub-spot-title"><i class="fa-solid fa-caret-right" style="color:var(--accent-color);"></i> ${spot.name}</div>
                            <div style="color:var(--text-sub); line-height:1.4; margin-bottom:8px;">${spot.desc}</div>
                            <div>${spotNav}${spotPhoto}${spotLink}</div>
                        </div>`;
                    }).join('');
                    subSpotsHtml = `<details class="sub-spots"><summary><i class="fa-solid fa-list-ul"></i> å±•é–‹è©³ç´°æ™¯é» (${item.subSpots.length})</summary>${spotsList}</details>`;
                }
                
                container.innerHTML += `
                    <div class="timeline-item ${catClass}">
                        <div class="timeline-dot"></div>
                        <div class="timeline-card glass">
                            <div class="time-text">${item.time}</div>
                            <div class="title-text">${formatText(item.title)}</div>
                            <div class="desc-text" style="margin-bottom:5px;">${formatText(item.desc)}</div>
                            ${mainNav}${mainLink}
                            ${tipHtml}
                            ${subSpotsHtml}
                        </div>
                    </div>
                `;
            });
        } else if (type === 'map') {
            const container = document.getElementById('map-route-container');
            const stopsHtml = data.mapStops.map((stop, i) => `<div class="map-stop-item">${i+1}. ${stop}</div>`).join('');
            // å¤šé»è·¯ç·šå°èˆªï¼Œä¸¦åŠ ä¸Š data=!4m2!4m1!3e3 å¼·åˆ¶ä½¿ç”¨å¤§çœ¾é‹è¼¸å·¥å…·
            const mapUrl = `https://www.google.com/maps/dir/${data.mapStops.map(s => encodeURIComponent(s)).join('/')}/data=!4m2!4m1!3e3`;
            container.innerHTML = `
                <h3 style="color:var(--text-sub); margin-bottom:10px;">ğŸ—ºï¸ ${data.day} è·¯ç·šé †åº</h3>
                <div class="map-route-card glass">
                    <div style="font-weight:700; font-size:16px;">${data.title}</div>
                    <div class="map-stops">${stopsHtml}</div>
                    <a href="${mapUrl}" target="_blank" class="route-btn"><i class="fa-solid fa-map-location-dot"></i> é–‹å•Ÿ Google Maps å°èˆª</a>
                </div>
            `;
        }
    }

    // --- 3. è¨˜å¸³é‚è¼¯ (Swipe to Delete å®Œå…¨ç„¡é€è‰²ç‰ˆ) ---
    let expenses = [];
    const exchangeRate = 0.21;

    function saveExpense() {
        const idInput = document.getElementById('edit-id');
        const dateInput = document.getElementById('exp-date').value;
        const catSelect = document.getElementById('exp-category');
        const amtInput = document.getElementById('exp-amount');
        const amount = parseInt(amtInput.value);
        const categoryText = catSelect.options[catSelect.selectedIndex].text;
        const editId = idInput.value;

        if (!dateInput || !amount || amount <= 0) { alert('è«‹å¡«å¯«å®Œæ•´ä¸”æœ‰æ•ˆçš„é‡‘é¡ï¼'); return; }

        if (editId) {
            const exp = expenses.find(e => e.id == editId);
            if(exp) { exp.date = dateInput; exp.category = categoryText; exp.amount = amount; }
            document.getElementById('btn-save-exp').innerHTML = `<i class="fa-solid fa-check"></i> ç¢ºèªæ–°å¢`;
            document.getElementById('btn-save-exp').style.background = 'var(--accent-color)';
            idInput.value = '';
        } else {
            expenses.push({ id: Date.now(), date: dateInput, category: categoryText, amount: amount });
        }
        amtInput.value = '';
        renderExpenses();
    }

    function editExpense(id) {
        const exp = expenses.find(e => e.id == id);
        if (!exp) return;
        document.getElementById('exp-date').value = exp.date;
        document.getElementById('exp-amount').value = exp.amount;
        document.getElementById('edit-id').value = exp.id;
        const catSelect = document.getElementById('exp-category');
        for (let i = 0; i < catSelect.options.length; i++) {
            if (catSelect.options[i].text === exp.category) { catSelect.selectedIndex = i; break; }
        }
        const btn = document.getElementById('btn-save-exp');
        btn.innerHTML = `<i class="fa-solid fa-pen"></i> æ›´æ–°å„²å­˜`;
        btn.style.background = '#FFB067';
        window.scrollTo({ top: 0, behavior: 'smooth' });
        document.getElementById(`track-${id}`).style.transform = `translateX(0)`;
    }

    function deleteExpense(id) {
        document.getElementById(`track-${id}`).style.transform = `translateX(0)`;
        setTimeout(() => {
            expenses = expenses.filter(e => e.id != id);
            renderExpenses();
        }, 200);
    }

    // æ»‘å‹•ç›¸é—œé‚è¼¯
    let startX = 0;
    let currentX = 0;
    
    window.ts = function(e) { 
        startX = e.touches[0].clientX; 
        currentX = 0;
    };
    
    window.tm = function(e, id) {
        let diff = e.touches[0].clientX - startX;
        let track = document.getElementById(`track-${id}`);
        
        if (diff < 0) {
            let move = diff;
            if (move < -140) { move = -140 + (move + 140) * 0.2; } // æ©¡çš®ç­‹é˜»åŠ›
            track.style.transition = 'none';
            track.style.transform = `translateX(${move}px)`;
            currentX = diff;
        }
    };
    
    window.te = function(e, id) {
        let track = document.getElementById(`track-${id}`);
        track.style.transition = 'transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1)';
        if (currentX < -40) {
            track.style.transform = `translateX(-140px)`;
        } else {
            track.style.transform = `translateX(0)`;
        }
    };

    function renderExpenses() {
        const container = document.getElementById('expense-list-container');
        container.innerHTML = '';
        const grouped = expenses.reduce((acc, exp) => {
            if(!acc[exp.date]) acc[exp.date] = { total: 0, items: [] };
            acc[exp.date].total += exp.amount;
            acc[exp.date].items.push(exp);
            return acc;
        }, {});

        const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));
        let grandTotalJpy = 0;

        sortedDates.forEach(date => {
            grandTotalJpy += grouped[date].total;
            let itemsHtml = grouped[date].items.map(exp => `
                <div class="swipe-wrapper">
                    <div class="swipe-track" id="track-${exp.id}" ontouchstart="ts(event)" ontouchmove="tm(event, ${exp.id})" ontouchend="te(event, ${exp.id})">
                        <div class="swipe-content">
                            <div style="font-weight:700; color:var(--text-main); font-size:15px;">${exp.category}</div>
                            <div style="color:var(--accent-color); font-weight:700; font-size:16px;">Â¥ ${exp.amount.toLocaleString()}</div>
                        </div>
                        <div class="swipe-actions">
                            <button class="swipe-btn edit" onclick="editExpense(${exp.id})"><i class="fa-solid fa-pen"></i></button>
                            <button class="swipe-btn delete" onclick="deleteExpense(${exp.id})"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML += `
                <div class="daily-expense-group">
                    <div class="daily-expense-title">
                        <span>ğŸ“… ${date}</span><span style="color:var(--accent-color);">å°è¨ˆ: Â¥ ${grouped[date].total.toLocaleString()}</span>
                    </div>
                    ${itemsHtml}
                </div>
            `;
        });

        const totalTwd = Math.round(grandTotalJpy * exchangeRate);
        document.getElementById('total-jpy').innerText = `Â¥ ${grandTotalJpy.toLocaleString()} (åŒ¯ç‡ ${exchangeRate})`;
        document.getElementById('total-twd').innerText = `NT$ ${totalTwd.toLocaleString()}`;
    }
</script>

</body>
</html>